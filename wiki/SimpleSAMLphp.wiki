#summary Integrate eid-idp in a php application with SimpleSAMLphp.

= Introduction =

This document describes how to enable eID authentication/identification through eid-idp in php application. [http://simpleSAMLphp.org SimpleSAMLphp] will be used for the SAML integration.


= Install SimpleSAMLphp =

Please refer to the SimpleSAMLphp documentation for installation instructions. We will consider the application as being installed on the default install location (/var/simplesamlphp), but other locations should work.

In the Apache httpd configuration, make sure an Alias is available to the www directory of the simplesamlphp distribution, as noted in the install documentation.

{{{
<VirtualHost *>
  #      ServerName service.example.com
        DocumentRoot /var/www/

        Alias /simplesaml /var/simplesamlphp/www
</VirtualHost>
}}}

= SimpleSAMLphp configuration =

First, edit */var/simplesamlphp/metadata/saml20-idp-remote.php*:

{{{
<?php
$metadata['e-contract'] = array (
  'entityid' => 'e-contract',
  'metadata-set' => 'saml20-idp-remote',
  'SingleSignOnService' => 'https://www.e-contract.be/eid-idp/protocol/saml2/post/auth-ident',
  'certFingerprint' => '6ce7a376a1394a1be3585536685d7fdc7da19fb6',
  'OrganizationName' => 'e-Contract eID IDP',
  'OrganizationURL' => 'http://www.e-contract.be'
);
?>
}}}

*!SingleSignOnService* and *certFingerprint* can be found on the eid-idp home page (e.g. https://www.e-contract.be/eid-idp/)

Edit */var/simplesamlphp/config/authsources.php*: set the entity ID of the eID IDP you just configured in saml20-idp-remote.php as default IDP.

{{{
<?php

$config = array(

        // An authentication source which can authenticate against both SAML 2.0
        // and Shibboleth 1.3 IdPs.
        'default-sp' => array(
                'saml:SP',

                // The entity ID of the IdP this should SP should contact.
                // Can be NULL/unset, in which case the user will be shown a list of available IdPs.
                'idp' => 'e-contract',

        ),

);
}}}

= Sample Service Provider script =

Put these files somewhere in the same folder in your httpd document tree

== index.php ==

{{{
<?php
require_once('/var/simplesamlphp/lib/_autoload.php');
$as = new SimpleSAML_Auth_Simple('default-sp');
$as->requireAuth();
?>
<html>
<head>
<title>eID IDP Test SP</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/> 
</head>
<body>
<?php
session_start();
$attributes = $as->getAttributes();
print ("Hello, " . $attributes["http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name"][0] . "<br />");

print ("<table>");
foreach ($attributes as $key => $value) {
  if ( $key == "be:fedict:eid:idp:photo") {
    $_SESSION["imagedata"] = $value[0];
    print ("<tr><td><strong>". $key . "</td><td><img src='image.php' /></td></tr>");
  }
  else
    print ("<tr><td><strong>" . $key . "</strong></td><td>" . $value[0] . "</td></tr>");
}
print ("</table>");
?>
</body>
</html>
}}}

==image.php==

{{{
<?php
# 
# image.php: simple jpeg generator with image payload in session variable
#   session variables:
#         imagedata : base64 encoded jpeg payload
#
# set jpeg mime type
header('Content-Type: image/jpeg');

session_start();
# echo decoded image payload
echo base64_decode($_SESSION["imagedata"]);
?>
}}}